# Unity MCP Server Makefile
# ç¼–è¯‘å¤šå¹³å°GoäºŒè¿›åˆ¶æ–‡ä»¶

# å˜é‡å®šä¹‰
BINARY_NAME=unity-mcp-server
VERSION=1.0.0
BIN_DIR=../bin
BUILD_FLAGS=-ldflags "-s -w -X main.version=$(VERSION)"

# é»˜è®¤ç›®æ ‡
.PHONY: all
all: clean deps build

# å®‰è£…ä¾èµ–
.PHONY: deps
deps:
	@echo "ğŸ“¦ å®‰è£…Goä¾èµ–..."
	go mod download
	go mod tidy

# ç¼–è¯‘æ‰€æœ‰å¹³å°
.PHONY: build
build: build-windows build-darwin build-linux
	@echo "âœ… æ‰€æœ‰å¹³å°ç¼–è¯‘å®Œæˆï¼"
	@echo ""
	@echo "ğŸ“ ç¼–è¯‘ç»“æœï¼š"
	@ls -la $(BIN_DIR)/*/

# Windows 64ä½
.PHONY: build-windows
build-windows:
	@echo "ğŸªŸ ç¼–è¯‘ Windows x64..."
	@mkdir -p $(BIN_DIR)/windows
	GOOS=windows GOARCH=amd64 go build $(BUILD_FLAGS) -o $(BIN_DIR)/windows/$(BINARY_NAME).exe .

# macOS 64ä½ (Intel)
.PHONY: build-darwin-amd64
build-darwin-amd64:
	@echo "ğŸ ç¼–è¯‘ macOS x64 (Intel)..."
	@mkdir -p $(BIN_DIR)/darwin
	GOOS=darwin GOARCH=amd64 go build $(BUILD_FLAGS) -o $(BIN_DIR)/darwin/$(BINARY_NAME)-amd64 .

# macOS ARM64 (Apple Silicon)
.PHONY: build-darwin-arm64
build-darwin-arm64:
	@echo "ğŸ ç¼–è¯‘ macOS ARM64 (Apple Silicon)..."
	@mkdir -p $(BIN_DIR)/darwin
	GOOS=darwin GOARCH=arm64 go build $(BUILD_FLAGS) -o $(BIN_DIR)/darwin/$(BINARY_NAME)-arm64 .

# macOS é€šç”¨äºŒè¿›åˆ¶ (åˆå¹¶Intelå’ŒARM64)
.PHONY: build-darwin
build-darwin: build-darwin-amd64 build-darwin-arm64
	@echo "ğŸ åˆ›å»º macOS é€šç”¨äºŒè¿›åˆ¶..."
	lipo -create -output $(BIN_DIR)/darwin/$(BINARY_NAME) \
		$(BIN_DIR)/darwin/$(BINARY_NAME)-amd64 \
		$(BIN_DIR)/darwin/$(BINARY_NAME)-arm64
	@rm $(BIN_DIR)/darwin/$(BINARY_NAME)-amd64 $(BIN_DIR)/darwin/$(BINARY_NAME)-arm64
	@chmod +x $(BIN_DIR)/darwin/$(BINARY_NAME)

# Linux 64ä½
.PHONY: build-linux
build-linux:
	@echo "ğŸ§ ç¼–è¯‘ Linux x64..."
	@mkdir -p $(BIN_DIR)/linux
	GOOS=linux GOARCH=amd64 go build $(BUILD_FLAGS) -o $(BIN_DIR)/linux/$(BINARY_NAME) .
	@chmod +x $(BIN_DIR)/linux/$(BINARY_NAME)

# æœ¬åœ°è¿è¡Œå¼€å‘ç‰ˆæœ¬
.PHONY: run
run:
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
	go run . -port=8080 -unity-host=localhost -unity-port=12345

# æµ‹è¯•
.PHONY: test
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	go test -v ./...

# æ¸…ç†ç¼–è¯‘æ–‡ä»¶
.PHONY: clean
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	@rm -rf $(BIN_DIR)/windows $(BIN_DIR)/darwin $(BIN_DIR)/linux
	@mkdir -p $(BIN_DIR)/windows $(BIN_DIR)/darwin $(BIN_DIR)/linux

# æ ¼å¼åŒ–ä»£ç 
.PHONY: fmt
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	go fmt ./...

# æ£€æŸ¥ä»£ç 
.PHONY: lint
lint:
	@echo "ğŸ” æ£€æŸ¥ä»£ç ..."
	go vet ./...

# æ˜¾ç¤ºå¸®åŠ©
.PHONY: help
help:
	@echo "Unity MCP Server æ„å»ºå·¥å…·"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤ï¼š"
	@echo "  make all              - å®Œæ•´æ„å»ºï¼ˆæ¸…ç†+ä¾èµ–+ç¼–è¯‘ï¼‰"
	@echo "  make deps             - å®‰è£…Goä¾èµ–"
	@echo "  make build            - ç¼–è¯‘æ‰€æœ‰å¹³å°"
	@echo "  make build-windows    - ä»…ç¼–è¯‘Windowsç‰ˆæœ¬"
	@echo "  make build-darwin     - ä»…ç¼–è¯‘macOSç‰ˆæœ¬"
	@echo "  make build-linux      - ä»…ç¼–è¯‘Linuxç‰ˆæœ¬"
	@echo "  make run              - æœ¬åœ°è¿è¡Œå¼€å‘ç‰ˆæœ¬"
	@echo "  make test             - è¿è¡Œæµ‹è¯•"
	@echo "  make clean            - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  make fmt              - æ ¼å¼åŒ–ä»£ç "
	@echo "  make lint             - æ£€æŸ¥ä»£ç "
	@echo "  make help             - æ˜¾ç¤ºæ­¤å¸®åŠ©"
	@echo ""
	@echo "ç¼–è¯‘åçš„æ–‡ä»¶ä½ç½®ï¼š"
	@echo "  Windows: ../bin/windows/$(BINARY_NAME).exe"
	@echo "  macOS:   ../bin/darwin/$(BINARY_NAME)"
	@echo "  Linux:   ../bin/linux/$(BINARY_NAME)"

# ç‰ˆæœ¬ä¿¡æ¯
.PHONY: version
version:
	@echo "Unity MCP Server v$(VERSION)"
	@echo "Go version: $$(go version)"